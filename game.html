<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVP Fighting Game - By Mina & Ava</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'VT323', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        #gameContainer {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            position: relative;
        }
        
        #storeScreen {
            display: block;
            color: white;
            font-family: 'VT323', monospace;
        }
        
        #storeTitle {
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            color: #f39c12;
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #e67e22;
        }
        
        #storeSplit {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .playerStore {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 3px solid #f39c12;
        }
        
        .playerStore h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        #player1Store {
            border-color: #3498db;
        }
        
        #player1Store h2 {
            color: #3498db;
        }
        
        #player2Store {
            border-color: #e74c3c;
        }
        
        #player2Store h2 {
            color: #e74c3c;
        }
        
        .coins {
            font-size: 24px;
            text-align: center;
            color: #f39c12;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .storeSection {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .storeSection h3, .inventorySection h3 {
            font-size: 20px;
            color: #f39c12;
            margin-bottom: 10px;
        }
        
        .storeSection h4 {
            font-size: 18px;
            color: #95a5a6;
            margin: 10px 0 5px 0;
        }
        
        .storeBtn {
            font-family: 'VT323', monospace;
            font-size: 20px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: 3px solid #229954;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .storeBtn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .storeBtn:active {
            transform: translateY(0);
        }
        
        .storeBtn:disabled {
            background: #7f8c8d;
            border-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .skinStore {
            margin-top: 10px;
        }
        
        .skinBtn {
            font-family: 'VT323', monospace;
            font-size: 16px;
            padding: 8px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
        }
        
        .skinBtn:hover {
            transform: scale(1.05);
            border-width: 3px;
        }
        
        .inventorySection {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .inventoryGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .weaponCard {
            background: rgba(255,255,255,0.1);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .weaponCard:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .weaponCard.selected {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.3);
            border-width: 3px;
        }
        
        .weaponCard .weaponName {
            font-size: 18px;
            font-weight: bold;
            color: #ecf0f1;
        }
        
        .weaponCard .weaponTier {
            font-size: 16px;
            color: #f39c12;
        }
        
        .selectedWeapons {
            font-size: 18px;
            color: #ecf0f1;
            margin-top: 10px;
        }
        
        #startBattleBtn {
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            padding: 20px 40px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            box-shadow: 0 5px 0 #c0392b;
            transition: all 0.3s;
        }
        
        #startBattleBtn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #a93226;
        }
        
        #startBattleBtn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #a93226;
        }
        
        #startBattleBtn:disabled {
            background: #7f8c8d;
            box-shadow: 0 5px 0 #5d6d7e;
            cursor: not-allowed;
        }
        
        #gameCanvas {
            border: 4px solid #f39c12;
            border-radius: 10px;
            background: linear-gradient(to bottom, #87ceeb 0%, #e0f6ff 100%);
            display: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        #ui {
            position: absolute;
            top: 40px;
            left: 40px;
            right: 40px;
            pointer-events: none;
            z-index: 10;
            display: none;
        }
        
        .player-info {
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 10px;
            display: inline-block;
            color: white;
            font-size: 20px;
            border: 2px solid #f39c12;
        }
        
        #player1Info {
            float: left;
            border-color: #3498db;
        }
        
        #player2Info {
            float: right;
            border-color: #e74c3c;
        }
        
        #gameCode {
            text-align: center;
            background: rgba(0,0,0,0.7);
            color: #f39c12;
            padding: 8px 20px;
            border-radius: 8px;
            display: inline-block;
            margin: 0 auto;
            font-size: 18px;
            border: 2px solid #f39c12;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            text-align: center;
            border: 2px solid #f39c12;
            display: none;
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            display: none;
            border: 4px solid #f39c12;
            pointer-events: auto;
        }
        
        #gameOver h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 36px;
            color: #f39c12;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #e67e22;
        }
        
        #gameOver p {
            font-size: 24px;
            color: white;
            margin-bottom: 30px;
        }
        
        #restartBtn {
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            padding: 15px 30px;
            background: #f39c12;
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 0 #e67e22;
        }
        
        #restartBtn:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #d35400;
        }
        
        #restartBtn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #d35400;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="storeScreen">
            <h1 id="storeTitle">PVP FIGHTING GAME - STORE</h1>
            <div id="storeSplit">
                <!-- Player 1 Store -->
                <div class="playerStore" id="player1Store">
                    <h2>PLAYER 1 (BLUE)</h2>
                    <div class="coins">Coins: $<span id="p1Coins">0</span></div>
                    
                    <div class="storeSection">
                        <h3>STORE</h3>
                        <button class="storeBtn" id="p1BuyWeapon">Mystery Box - $100</button>
                        <button class="storeBtn" id="p1BuyAbility">Ability - $200</button>
                        <div class="skinStore">
                            <h4>Skins - $10 each</h4>
                            <button class="skinBtn" data-player="1" data-color="#3498db">Default Blue</button>
                            <button class="skinBtn" data-player="1" data-color="#9b59b6">Purple</button>
                            <button class="skinBtn" data-player="1" data-color="#1abc9c">Teal</button>
                            <button class="skinBtn" data-player="1" data-color="#f39c12">Orange</button>
                        </div>
                    </div>
                    
                    <div class="inventorySection">
                        <h3>YOUR INVENTORY (Click 3 for battle)</h3>
                        <div id="p1Inventory" class="inventoryGrid"></div>
                        <div class="selectedWeapons">
                            <strong>Selected:</strong> <span id="p1Selected">None</span>
                        </div>
                    </div>
                </div>
                
                <!-- Player 2 Store -->
                <div class="playerStore" id="player2Store">
                    <h2>PLAYER 2 (RED)</h2>
                    <div class="coins">Coins: $<span id="p2Coins">0</span></div>
                    
                    <div class="storeSection">
                        <h3>STORE</h3>
                        <button class="storeBtn" id="p2BuyWeapon">Mystery Box - $100</button>
                        <button class="storeBtn" id="p2BuyAbility">Ability - $200</button>
                        <div class="skinStore">
                            <h4>Skins - $10 each</h4>
                            <button class="skinBtn" data-player="2" data-color="#e74c3c">Default Red</button>
                            <button class="skinBtn" data-player="2" data-color="#e67e22">Dark Orange</button>
                            <button class="skinBtn" data-player="2" data-color="#c0392b">Dark Red</button>
                            <button class="skinBtn" data-player="2" data-color="#8e44ad">Dark Purple</button>
                        </div>
                    </div>
                    
                    <div class="inventorySection">
                        <h3>YOUR INVENTORY (Click 3 for battle)</h3>
                        <div id="p2Inventory" class="inventoryGrid"></div>
                        <div class="selectedWeapons">
                            <strong>Selected:</strong> <span id="p2Selected">None</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="startBattleBtn">START BATTLE</button>
        </div>
        
        <div id="ui">
            <div id="gameCode">GAME CODE: XXXXXX</div>
            <div id="player1Info" class="player-info">P1: Loading...</div>
            <div id="player2Info" class="player-info">P2: Loading...</div>
        </div>
        <canvas id="gameCanvas" width="1200" height="700"></canvas>
        <div id="controls">
            P1: WASD + S(Attack) + 1/2/3(Weapons) + SPACE(Ability) | P2: Arrows + Down(Attack) + 4/5/6(Weapons) + ENTER(Ability)
        </div>
        <div id="gameOver">
            <h1 id="winnerText">PLAYER WINS!</h1>
            <p>Returning to store in 3 seconds...</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game constants
        const GRAVITY = 0.8;
        const JUMP_STRENGTH = -15;
        const PLAYER_SPEED = 5;
        const FPS = 60;
        
        // Generate game code
        const gameCode = Array(6).fill(0).map(() => 
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]
        ).join('');
        document.getElementById('gameCode').textContent = `GAME CODE: ${gameCode}`;
        
        // Game state
        let gameState = {
            running: true,
            gameOver: false,
            winner: null,
            projectiles: [],
            comets: [],
            cometSpawnTimer: 0,
            icicles: [],
            icicleSpawnTimer: 0,
            lavaHeight: 0,
            lavaRiseTimer: 0,
            spaceships: [],
            beamedPlayers: { p1: null, p2: null },
            currentMap: 'normal',
            inStore: true,
            inMinigame: false,
            minigameObjects: [],
            minigameTimer: 0,
            minigameSpawnRate: 120, // frames between spawns
            // Easter egg
            easterEggKeys: [],
            easterEggActive: false,
            easterEggCooldown: 0,
            snowman: null
        };
        
        // Player persistent data
        let playerData = {
            p1: {
                coins: 0,
                inventory: [],
                selectedWeapons: [],
                color: '#3498db',
                ability: null
            },
            p2: {
                coins: 0,
                inventory: [],
                selectedWeapons: [],
                color: '#e74c3c',
                ability: null
            }
        };
        
        // Keyboard state
        const keys = {};

        // Helper: Check if any key in an array (or single key) is pressed
        function isKeyPressed(control) {
            if (Array.isArray(control)) {
                return control.some(key => keys[key]);
            }
            return keys[control];
        }

        // Platform class
        class Platform {
            constructor(x, y, width, height, color = '#8B4513') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
            }
            
            checkCollision(player) {
                // Check if player is falling down
                if (player.velY >= 0) {
                    // Check horizontal overlap
                    if (player.x + player.width > this.x &&
                        player.x < this.x + this.width) {
                        // Check if player's feet are at or below platform top
                        // and were above it in the previous frame
                        if (player.y + player.height >= this.y &&
                            player.y + player.height - player.velY <= this.y) {
                            player.y = this.y - player.height;
                            player.velY = 0;
                            return true;
                        }
                    }
                }
                return false;
            }
        }
        
        // Weapon class
        class Weapon {
            constructor(name, damage, type, tier) {
                this.name = name;
                this.damage = damage;
                this.type = type; // 'melee' or 'ranged'
                this.tier = tier;
            }
        }
        
        // Comet class
        class Comet {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = -50;
                this.radius = 15;
                this.speed = 5 + Math.random() * 3;
                this.damage = 30;
                this.active = true;
            }
            
            update() {
                this.y += this.speed;
                
                // Remove if off screen
                if (this.y > canvas.height) {
                    this.active = false;
                }
            }
            
            draw() {
                // Draw comet with trail
                ctx.fillStyle = '#FF4500';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw trail
                ctx.fillStyle = 'rgba(255, 165, 0, 0.5)';
                ctx.beginPath();
                ctx.arc(this.x, this.y - 20, this.radius * 0.7, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(255, 69, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(this.x, this.y - 35, this.radius * 0.4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            checkHit(player) {
                // Can't hit invisible players
                if (player.isInvisible()) return false;
                
                const distance = Math.sqrt(
                    Math.pow(this.x - (player.x + player.width/2), 2) +
                    Math.pow(this.y - (player.y + player.height/2), 2)
                );
                return distance < this.radius + 20;
            }
        }
        
        // Icicle class
        class Icicle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 10;
                this.height = 25;
                this.speed = 6;
                this.damage = Math.floor(Math.random() * 20) + 1; // 1-20 damage
                this.active = true;
            }
            
            update() {
                this.y += this.speed;
                
                // Remove if off screen
                if (this.y > canvas.height) {
                    this.active = false;
                }
            }
            
            draw() {
                ctx.fillStyle = '#B0E0E6';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x - this.width/2, this.y - this.height);
                ctx.lineTo(this.x + this.width/2, this.y - this.height);
                ctx.closePath();
                ctx.fill();
                
                // Shine effect
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.moveTo(this.x - 2, this.y - 5);
                ctx.lineTo(this.x - 2, this.y - 15);
                ctx.lineTo(this.x + 2, this.y - 10);
                ctx.closePath();
                ctx.fill();
            }
            
            checkHit(player) {
                if (player.isInvisible()) return false;
                
                return this.x > player.x &&
                       this.x < player.x + player.width &&
                       this.y > player.y &&
                       this.y < player.y + player.height;
            }
        }
        
        // Spaceship class
        class Spaceship {
            constructor(x, y, beamHeight) {
                this.x = x;
                this.y = y;
                this.width = 60;
                this.height = 30;
                this.beamHeight = beamHeight; // How high the beam lifts players
                this.beamWidth = 40;
            }
            
            draw() {
                // Draw UFO
                ctx.fillStyle = '#808080';
                ctx.beginPath();
                ctx.ellipse(this.x, this.y, this.width/2, this.height/2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw dome
                ctx.fillStyle = '#A0A0A0';
                ctx.beginPath();
                ctx.ellipse(this.x, this.y - 10, this.width/3, this.height/3, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw lights
                ctx.fillStyle = '#00FF00';
                ctx.beginPath();
                ctx.arc(this.x - 15, this.y + 5, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(this.x + 15, this.y + 5, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw beam
                ctx.fillStyle = 'rgba(0, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.moveTo(this.x - this.beamWidth/2, this.y + this.height/2);
                ctx.lineTo(this.x + this.beamWidth/2, this.y + this.height/2);
                ctx.lineTo(this.x + this.beamWidth/2, canvas.height - 50);
                ctx.lineTo(this.x - this.beamWidth/2, canvas.height - 50);
                ctx.closePath();
                ctx.fill();
            }
            
            checkBeamHit(player) {
                // Check if player is in beam
                const playerCenterX = player.x + player.width/2;
                return playerCenterX > this.x - this.beamWidth/2 &&
                       playerCenterX < this.x + this.beamWidth/2 &&
                       player.y + player.height >= this.y + this.height/2;
            }
        }
        
        // FallingObject class for minigame
        class FallingObject {
            constructor(x, side) {
                this.x = x;
                this.y = -30;
                this.side = side; // 'left' or 'right'
                this.speed = 3 + Math.random() * 3;
                this.size = 20 + Math.random() * 15;
                this.active = true;
                
                // Random object type
                const types = ['rock', 'meteor', 'bomb', 'anvil'];
                this.type = types[Math.floor(Math.random() * types.length)];
                
                // Color based on type
                if (this.type === 'rock') this.color = '#808080';
                else if (this.type === 'meteor') this.color = '#FF4500';
                else if (this.type === 'bomb') this.color = '#000000';
                else if (this.type === 'anvil') this.color = '#4a4a4a';
            }
            
            update() {
                this.y += this.speed;
                
                // Remove if off screen
                if (this.y > canvas.height) {
                    this.active = false;
                }
            }
            
            draw() {
                if (this.type === 'bomb') {
                    // Draw bomb
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Fuse
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y - this.size/2);
                    ctx.lineTo(this.x - 5, this.y - this.size/2 - 8);
                    ctx.stroke();
                    
                    // Spark
                    ctx.fillStyle = '#FF6347';
                    ctx.beginPath();
                    ctx.arc(this.x - 5, this.y - this.size/2 - 8, 3, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.type === 'meteor') {
                    // Draw meteor with trail
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 165, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(this.x - 5, this.y - 10, this.size/3, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // Draw rock or anvil
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
                }
            }
            
            checkHit(player) {
                const distance = Math.sqrt(
                    Math.pow(this.x - (player.x + player.width/2), 2) +
                    Math.pow(this.y - (player.y + player.height/2), 2)
                );
                return distance < this.size/2 + 20;
            }
        }
        
        // Snowman class (Easter Egg)
        class Snowman {
            constructor() {
                this.type = Math.random() < 0.5 ? 'sign' : 'snowboard';
                this.size = 160; // Twice the size of players (80 total)
                this.active = true;
                this.timer = 0;
                
                if (this.type === 'sign') {
                    // Sneaky sign holder - enters from random side
                    const sides = ['left', 'right', 'top', 'bottom'];
                    this.side = sides[Math.floor(Math.random() * sides.length)];
                    this.speed = 2;
                    this.pauseTime = 180; // 3 seconds at 60fps
                    this.state = 'entering'; // entering, showing, leaving
                    
                    if (this.side === 'left') {
                        this.x = -this.size;
                        this.y = canvas.height / 2;
                        this.targetX = 150;
                    } else if (this.side === 'right') {
                        this.x = canvas.width + this.size;
                        this.y = canvas.height / 2;
                        this.targetX = canvas.width - 150;
                    } else if (this.side === 'top') {
                        this.x = canvas.width / 2;
                        this.y = -this.size;
                        this.targetY = 150;
                    } else {
                        this.x = canvas.width / 2;
                        this.y = canvas.height + this.size;
                        this.targetY = canvas.height - 150;
                    }
                } else {
                    // Snowboarder - goes across screen
                    this.speed = 5; // Slower so text is readable
                    this.direction = Math.random() < 0.5 ? 1 : -1;
                    this.y = canvas.height / 2;
                    
                    if (this.direction === 1) {
                        this.x = -this.size;
                    } else {
                        this.x = canvas.width + this.size;
                    }
                }
            }
            
            update() {
                this.timer++;
                
                if (this.type === 'sign') {
                    if (this.state === 'entering') {
                        // Move towards target
                        if (this.side === 'left' || this.side === 'right') {
                            if (Math.abs(this.x - this.targetX) > this.speed) {
                                this.x += this.speed * (this.side === 'left' ? 1 : -1);
                            } else {
                                this.x = this.targetX;
                                this.state = 'showing';
                                this.timer = 0;
                            }
                        } else {
                            if (Math.abs(this.y - this.targetY) > this.speed) {
                                this.y += this.speed * (this.side === 'top' ? 1 : -1);
                            } else {
                                this.y = this.targetY;
                                this.state = 'showing';
                                this.timer = 0;
                            }
                        }
                    } else if (this.state === 'showing') {
                        // Pause to show sign
                        if (this.timer >= this.pauseTime) {
                            this.state = 'leaving';
                        }
                    } else if (this.state === 'leaving') {
                        // Leave the way we came
                        if (this.side === 'left') {
                            this.x -= this.speed;
                            if (this.x < -this.size) this.active = false;
                        } else if (this.side === 'right') {
                            this.x += this.speed;
                            if (this.x > canvas.width + this.size) this.active = false;
                        } else if (this.side === 'top') {
                            this.y -= this.speed;
                            if (this.y < -this.size) this.active = false;
                        } else {
                            this.y += this.speed;
                            if (this.y > canvas.height + this.size) this.active = false;
                        }
                    }
                } else {
                    // Snowboarder
                    this.x += this.speed * this.direction;
                    
                    // Remove when off screen
                    if (this.direction === 1 && this.x > canvas.width + this.size) {
                        this.active = false;
                    } else if (this.direction === -1 && this.x < -this.size) {
                        this.active = false;
                    }
                }
            }
            
            draw() {
                ctx.save();
                
                if (this.type === 'snowboard') {
                    // Tilt for snowboarding effect
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.direction * 0.2);
                    ctx.translate(-this.x, -this.y);
                }
                
                // Draw Abominable Snowman / Yeti
                const bodyY = this.y;
                
                // Draw fur texture function
                const drawFur = (x, y, radius) => {
                    for (let i = 0; i < 12; i++) {
                        const angle = (Math.PI * 2 * i) / 12;
                        const furX = x + Math.cos(angle) * radius;
                        const furY = y + Math.sin(angle) * radius;
                        ctx.fillStyle = '#F0F8FF';
                        ctx.beginPath();
                        ctx.arc(furX, furY, radius * 0.15, 0, Math.PI * 2);
                        ctx.fill();
                    }
                };
                
                // Large furry body
                ctx.fillStyle = '#E6F2FF';
                ctx.beginPath();
                ctx.arc(this.x, bodyY + 20, 55, 0, Math.PI * 2);
                ctx.fill();
                drawFur(this.x, bodyY + 20, 55);
                
                // Furry torso
                ctx.fillStyle = '#E6F2FF';
                ctx.beginPath();
                ctx.arc(this.x, bodyY - 20, 45, 0, Math.PI * 2);
                ctx.fill();
                drawFur(this.x, bodyY - 20, 45);
                
                // Large furry head
                ctx.fillStyle = '#E6F2FF';
                ctx.beginPath();
                ctx.arc(this.x, bodyY - 65, 35, 0, Math.PI * 2);
                ctx.fill();
                drawFur(this.x, bodyY - 65, 35);
                
                // Fierce eyes (red/glowing)
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(this.x - 12, bodyY - 70, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(this.x + 12, bodyY - 70, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Black pupils
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(this.x - 12, bodyY - 70, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(this.x + 12, bodyY - 70, 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Large black nose
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(this.x, bodyY - 58, 6, 0, Math.PI * 2);
                ctx.fill();
                
                // Scary mouth with fangs
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(this.x, bodyY - 52, 15, 0.3, Math.PI - 0.3);
                ctx.stroke();
                
                // Fangs
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.moveTo(this.x - 8, bodyY - 45);
                ctx.lineTo(this.x - 6, bodyY - 38);
                ctx.lineTo(this.x - 4, bodyY - 45);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.moveTo(this.x + 4, bodyY - 45);
                ctx.lineTo(this.x + 6, bodyY - 38);
                ctx.lineTo(this.x + 8, bodyY - 45);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // Muscular furry arms with claws
                ctx.strokeStyle = '#B0C4DE';
                ctx.lineWidth = 12;
                ctx.beginPath();
                ctx.moveTo(this.x - 40, bodyY - 25);
                ctx.lineTo(this.x - 65, bodyY - 30);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(this.x + 40, bodyY - 25);
                ctx.lineTo(this.x + 65, bodyY - 30);
                ctx.stroke();
                
                // Claws
                ctx.strokeStyle = '#808080';
                ctx.lineWidth = 3;
                for (let i = -1; i <= 1; i++) {
                    ctx.beginPath();
                    ctx.moveTo(this.x - 65 + i * 5, bodyY - 30);
                    ctx.lineTo(this.x - 70 + i * 5, bodyY - 38);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(this.x + 65 + i * 5, bodyY - 30);
                    ctx.lineTo(this.x + 70 + i * 5, bodyY - 38);
                    ctx.stroke();
                }
                
                // Furry legs
                ctx.fillStyle = '#E6F2FF';
                ctx.fillRect(this.x - 25, bodyY + 60, 20, 30);
                ctx.fillRect(this.x + 5, bodyY + 60, 20, 30);
                drawFur(this.x - 15, bodyY + 75, 15);
                drawFur(this.x + 15, bodyY + 75, 15);
                
                if (this.type === 'sign') {
                    // Draw sign
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(this.x + 45, bodyY - 20, 8, 60);
                    
                    ctx.fillStyle = '#F5DEB3';
                    ctx.fillRect(this.x + 30, bodyY - 35, 100, 50);
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(this.x + 30, bodyY - 35, 100, 50);
                    
                    // Text on sign
                    ctx.fillStyle = '#8B4513';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Mina is', this.x + 80, bodyY - 20);
                    ctx.fillText('the Beast', this.x + 80, bodyY - 5);
                    ctx.textAlign = 'left';
                } else {
                    // Draw snowboard
                    ctx.fillStyle = '#FF4500';
                    const boardWidth = 80;
                    const boardHeight = 20;
                    ctx.fillRect(this.x - boardWidth/2, bodyY + 65, boardWidth, boardHeight);
                    
                    // Snowboard details
                    ctx.strokeStyle = '#8B0000';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(this.x - boardWidth/2, bodyY + 65, boardWidth, boardHeight);
                    
                    // "DEFEATED" text on board
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('DEFEATED', this.x, bodyY + 78);
                    ctx.textAlign = 'left';
                }
                
                ctx.restore();
            }
        }
        
        // Projectile class
        class Projectile {
            constructor(x, y, direction, damage, color) {
                this.x = x;
                this.y = y;
                this.direction = direction;
                this.damage = damage;
                this.color = color;
                this.speed = 10;
                this.active = true;
                this.width = 10;
                this.height = 5;
            }
            
            update() {
                this.x += this.direction * this.speed;
                if (this.x < 0 || this.x > canvas.width) {
                    this.active = false;
                }
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            
            checkHit(player) {
                // Can't hit invisible players
                if (player.isInvisible()) return false;
                
                return this.x < player.x + player.width &&
                       this.x + this.width > player.x &&
                       this.y < player.y + player.height &&
                       this.y + this.height > player.y;
            }
        }
        
        // Player class
        class Player {
            constructor(x, y, color, name, controls) {
                this.x = x;
                this.y = y;
                this.width = 40;
                this.height = 60;
                this.color = color;
                this.velX = 0;
                this.velY = 0;
                this.facingRight = true;
                this.onGround = false;
                this.health = 100;
                this.maxHealth = 100;
                this.name = name;
                this.controls = controls;
                
                this.weapons = [];
                this.currentWeaponIndex = 0;
                this.attackCooldown = 0;
                this.isAttacking = false;
                this.attackTimer = 0;
                
                // Abilities
                this.ability = null;
                this.abilityActive = false;
                this.abilityDuration = 0;
                this.abilityCooldown = 0;
                
                // Ice sliding
                this.slideVel = 0;
                
                // Alien beam
                this.isBeamed = false;
                this.beamTargetY = 0;
            }
            
            getCurrentWeapon() {
                return this.weapons[this.currentWeaponIndex] || null;
            }
            
            switchWeapon(index) {
                if (index >= 0 && index < this.weapons.length) {
                    this.currentWeaponIndex = index;
                }
            }
            
            move(platforms) {
                // If beamed, handle beam physics
                if (this.isBeamed) {
                    // Float towards beam target height
                    if (this.y > this.beamTargetY) {
                        this.y -= 3;
                    } else if (this.y < this.beamTargetY) {
                        this.y = this.beamTargetY;
                        this.velY = 0;
                    }
                    
                    // Can still move horizontally slowly
                    this.velX = 0;
                    const speed = (this.hasSpeed() ? PLAYER_SPEED * 2 : PLAYER_SPEED) * 0.5;
                    if (isKeyPressed(this.controls.left)) {
                        this.velX = -speed;
                        this.facingRight = false;
                        this.isBeamed = false; // Exit beam when moving
                    }
                    if (isKeyPressed(this.controls.right)) {
                        this.velX = speed;
                        this.facingRight = true;
                        this.isBeamed = false; // Exit beam when moving
                    }
                    
                    this.x += this.velX;
                    
                    // Boundaries
                    if (this.x < 0) this.x = 0;
                    if (this.x + this.width > canvas.width) {
                        this.x = canvas.width - this.width;
                    }
                    
                    return;
                }
                
                // Normal movement
                this.velX = 0;
                
                const speed = this.hasSpeed() ? PLAYER_SPEED * 2 : PLAYER_SPEED;
                const isIce = gameState.currentMap === 'ice';
                
                if (isKeyPressed(this.controls.left)) {
                    this.velX = -speed;
                    this.facingRight = false;
                    if (isIce && this.onGround) {
                        this.slideVel = -speed * 0.6; // Set slide velocity
                    }
                }
                if (isKeyPressed(this.controls.right)) {
                    this.velX = speed;
                    this.facingRight = true;
                    if (isIce && this.onGround) {
                        this.slideVel = speed * 0.6;
                    }
                }
                
                // Apply slide on ice
                if (isIce && this.onGround && this.velX === 0 && this.slideVel !== 0) {
                    this.x += this.slideVel;
                    this.slideVel *= 0.85; // Friction
                    if (Math.abs(this.slideVel) < 0.1) {
                        this.slideVel = 0;
                    }
                } else if (!isIce) {
                    this.slideVel = 0;
                }
                
                if (isKeyPressed(this.controls.jump) && this.onGround) {
                    this.velY = JUMP_STRENGTH;
                    this.onGround = false;
                }
                
                this.velY += GRAVITY;
                
                this.x += this.velX;
                this.y += this.velY;
                
                // Platform collision
                this.onGround = false;
                for (let platform of platforms) {
                    if (platform.checkCollision(this)) {
                        this.onGround = true;
                    }
                }
                
                // Ground collision
                if (this.y + this.height >= canvas.height - 50) {
                    this.y = canvas.height - 50 - this.height;
                    this.velY = 0;
                    this.onGround = true;
                }
                
                // Boundaries
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) {
                    this.x = canvas.width - this.width;
                }
                
                // Minigame boundaries - can't cross middle
                if (gameState.inMinigame) {
                    const midX = canvas.width / 2;
                    if (this.name === 'Player 1' && this.x + this.width > midX) {
                        this.x = midX - this.width;
                    }
                    if (this.name === 'Player 2' && this.x < midX) {
                        this.x = midX;
                    }
                }
            }
            
            attack() {
                if (this.attackCooldown === 0 && this.weapons.length > 0) {
                    this.isAttacking = true;
                    this.attackTimer = 15;
                    this.attackCooldown = 60;
                    return this.getCurrentWeapon();
                }
                return null;
            }
            
            updateTimers() {
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.attackTimer > 0) {
                    this.attackTimer--;
                } else {
                    this.isAttacking = false;
                }
                
                // Ability timers
                if (this.abilityActive && this.abilityDuration > 0) {
                    this.abilityDuration--;
                    if (this.abilityDuration === 0) {
                        this.abilityActive = false;
                        // Teleport has 2 second cooldown, others have 10 seconds
                        this.abilityCooldown = this.ability === 'teleport' ? 120 : 600; // 2 or 10 seconds at 60 FPS
                    }
                }
                
                if (this.abilityCooldown > 0) {
                    this.abilityCooldown--;
                }
            }
            
            activateAbility() {
                if (!this.ability || this.abilityActive || this.abilityCooldown > 0) {
                    return false;
                }
                
                this.abilityActive = true;
                this.abilityDuration = 600; // 10 seconds at 60 FPS
                return true;
            }
            
            isInvisible() {
                return this.abilityActive && this.ability === 'invisibility';
            }
            
            hasShield() {
                return this.abilityActive && this.ability === 'shield';
            }
            
            hasSpeed() {
                return this.abilityActive && this.ability === 'speed';
            }
            
            takeDamage(damage) {
                // Shield blocks all damage
                if (this.hasShield()) {
                    return;
                }
                
                this.health -= damage;
                if (this.health < 0) this.health = 0;
            }
            
            draw() {
                // Don't draw if invisible
                if (this.isInvisible()) {
                    // Draw faint outline only
                    ctx.globalAlpha = 0.2;
                }
                
                // Draw body (oval)
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(this.x + this.width/2, this.y + this.height/2 + 5, 
                           this.width/2, this.height/2 - 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw head
                ctx.beginPath();
                ctx.arc(this.x + this.width/2, this.y + 15, 12, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw eye
                ctx.fillStyle = 'black';
                const eyeX = this.facingRight ? this.x + this.width/2 + 4 : this.x + this.width/2 - 4;
                ctx.beginPath();
                ctx.arc(eyeX, this.y + 12, 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = 1.0;
                
                // Draw shield effect
                if (this.hasShield()) {
                    ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, 40, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Draw weapon
                this.drawWeapon();
                
                // Draw health bar
                const barWidth = 50;
                const barHeight = 5;
                const barX = this.x - 5;
                const barY = this.y - 15;
                
                ctx.fillStyle = 'red';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                ctx.fillStyle = 'green';
                const healthWidth = (this.health / this.maxHealth) * barWidth;
                ctx.fillRect(barX, barY, healthWidth, barHeight);
                
                // Draw ability cooldown indicator
                if (this.ability) {
                    const abilityBarY = this.y - 25;
                    const maxCooldown = this.ability === 'teleport' ? 120 : 600;
                    
                    if (this.abilityActive) {
                        // Show ability duration
                        ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
                        const durationWidth = (this.abilityDuration / 600) * barWidth;
                        ctx.fillRect(barX, abilityBarY, durationWidth, 3);
                    } else if (this.abilityCooldown > 0) {
                        // Show cooldown
                        ctx.fillStyle = 'rgba(128, 128, 128, 0.5)';
                        const cooldownWidth = ((maxCooldown - this.abilityCooldown) / maxCooldown) * barWidth;
                        ctx.fillRect(barX, abilityBarY, cooldownWidth, 3);
                    } else {
                        // Ready to use
                        ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                        ctx.fillRect(barX, abilityBarY, barWidth, 3);
                    }
                }
            }
            
            drawWeapon() {
                const weapon = this.getCurrentWeapon();
                if (!weapon) return;
                
                const offset = this.facingRight ? this.width : 0;
                const direction = this.facingRight ? 1 : -1;
                const handX = this.x + offset;
                const handY = this.y + this.height/2;
                
                // Attack animation angle
                const angleOffset = this.isAttacking ? (15 - this.attackTimer) * 6 : 0;
                
                // Different visuals based on weapon name
                if (weapon.name === "Sword") {
                    // Classic sword
                    ctx.strokeStyle = '#C0C0C0';
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(handX + direction * 35, handY - angleOffset);
                    ctx.stroke();
                    // Hilt
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 8;
                    ctx.beginPath();
                    ctx.moveTo(handX - direction * 5, handY);
                    ctx.lineTo(handX + direction * 5, handY);
                    ctx.stroke();
                    
                } else if (weapon.name === "Banana Sword") {
                    // Yellow curved banana
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 8;
                    ctx.beginPath();
                    ctx.arc(handX + direction * 15, handY - 10 - angleOffset/2, 20, 
                           direction > 0 ? 0.5 : 2.6, direction > 0 ? 2.6 : 0.5);
                    ctx.stroke();
                    
                } else if (weapon.name === "Fish") {
                    // Fish shape
                    ctx.fillStyle = '#4682B4';
                    ctx.beginPath();
                    ctx.ellipse(handX + direction * 15, handY - angleOffset/2, 18, 8, 
                               direction > 0 ? 0 : Math.PI, 0, Math.PI * 2);
                    ctx.fill();
                    // Tail
                    ctx.beginPath();
                    ctx.moveTo(handX + direction * 30, handY - angleOffset/2);
                    ctx.lineTo(handX + direction * 35, handY - 5 - angleOffset/2);
                    ctx.lineTo(handX + direction * 35, handY + 5 - angleOffset/2);
                    ctx.closePath();
                    ctx.fill();
                    
                } else if (weapon.name === "Frying Pan") {
                    // Pan circle
                    ctx.fillStyle = '#708090';
                    ctx.beginPath();
                    ctx.arc(handX + direction * 25, handY - angleOffset/2, 12, 0, Math.PI * 2);
                    ctx.fill();
                    // Handle
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(handX + direction * 15, handY - angleOffset/3);
                    ctx.stroke();
                    
                } else if (weapon.name === "Giant Lollipop") {
                    // Lollipop circle (colorful)
                    const colors = ['#FF69B4', '#FF1493', '#FFC0CB'];
                    for (let i = 0; i < 3; i++) {
                        ctx.fillStyle = colors[i];
                        ctx.beginPath();
                        ctx.arc(handX + direction * 25, handY - angleOffset/2, 
                               12 - i * 4, i * Math.PI/3, (i+2) * Math.PI/3);
                        ctx.fill();
                    }
                    // Stick
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(handX + direction * 18, handY - angleOffset/3);
                    ctx.stroke();
                    
                } else if (weapon.name === "Lightsaber") {
                    // Glowing blade
                    ctx.strokeStyle = '#00FFFF';
                    ctx.lineWidth = 8;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#00FFFF';
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(handX + direction * 40, handY - angleOffset);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    // Hilt
                    ctx.fillStyle = '#808080';
                    ctx.fillRect(handX - direction * 8, handY - 3, direction * 10, 6);
                    
                } else if (weapon.name === "Chainsaw") {
                    // Chainsaw blade
                    ctx.fillStyle = '#FF4500';
                    ctx.fillRect(handX + direction * 5, handY - 8 - angleOffset/3, direction * 25, 16);
                    // Teeth
                    ctx.fillStyle = '#C0C0C0';
                    for (let i = 0; i < 5; i++) {
                        ctx.beginPath();
                        ctx.moveTo(handX + direction * (8 + i * 5), handY - 8 - angleOffset/3);
                        ctx.lineTo(handX + direction * (10 + i * 5), handY - 12 - angleOffset/3);
                        ctx.lineTo(handX + direction * (12 + i * 5), handY - 8 - angleOffset/3);
                        ctx.fill();
                    }
                    
                } else if (weapon.name === "Electric Guitar") {
                    // Guitar body
                    ctx.fillStyle = '#8B008B';
                    ctx.beginPath();
                    ctx.ellipse(handX + direction * 20, handY - angleOffset/2, 15, 10, 
                               direction > 0 ? -0.3 : 0.3, 0, Math.PI * 2);
                    ctx.fill();
                    // Neck
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(handX + direction * 35, handY - 5 - angleOffset/2);
                    ctx.stroke();
                    // Lightning bolts when attacking
                    if (this.isAttacking) {
                        ctx.strokeStyle = '#FFFF00';
                        ctx.lineWidth = 2;
                        for (let i = 0; i < 3; i++) {
                            ctx.beginPath();
                            ctx.moveTo(handX + direction * 20, handY - 10);
                            ctx.lineTo(handX + direction * (25 + i * 5), handY - 15 - i * 3);
                            ctx.stroke();
                        }
                    }
                    
                } else if (weapon.name === "Bow") {
                    // Bow arc
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.arc(handX + direction * 10, handY, 15, 
                           direction > 0 ? -Math.PI/2 : Math.PI/2, 
                           direction > 0 ? Math.PI/2 : -Math.PI/2);
                    ctx.stroke();
                    // Arrow when attacking
                    if (this.isAttacking) {
                        ctx.strokeStyle = '#D2691E';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(handX + direction * 10, handY);
                        ctx.lineTo(handX + direction * 30, handY);
                        ctx.stroke();
                    }
                    
                } else if (weapon.name === "Gun") {
                    // Gun body
                    ctx.fillStyle = '#2F4F4F';
                    ctx.fillRect(handX, handY - 5, direction * 20, 10);
                    // Barrel
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(handX + direction * 20, handY - 3, direction * 8, 6);
                    
                } else if (weapon.name === "Water Gun") {
                    // Water gun - bright blue
                    ctx.fillStyle = '#00BFFF';
                    ctx.fillRect(handX, handY - 6, direction * 22, 12);
                    // Nozzle
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(handX + direction * 22, handY - 3, direction * 6, 6);
                    // Water spray when attacking
                    if (this.isAttacking) {
                        ctx.fillStyle = 'rgba(0, 191, 255, 0.5)';
                        for (let i = 0; i < 5; i++) {
                            ctx.beginPath();
                            ctx.arc(handX + direction * (28 + i * 5), handY + (Math.random() - 0.5) * 10, 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    
                } else if (weapon.name === "Snowball Launcher") {
                    // Launcher tube
                    ctx.fillStyle = '#ADD8E6';
                    ctx.fillRect(handX, handY - 7, direction * 25, 14);
                    // Snowball
                    if (this.isAttacking) {
                        ctx.fillStyle = '#FFFFFF';
                        ctx.beginPath();
                        ctx.arc(handX + direction * 30, handY, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                } else if (weapon.name === "Confetti Cannon") {
                    // Cannon
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(handX, handY - 8, direction * 20, 16);
                    // Confetti when attacking
                    if (this.isAttacking) {
                        const colors = ['#FF69B4', '#00FF00', '#FFFF00', '#FF0000', '#0000FF'];
                        for (let i = 0; i < 8; i++) {
                            ctx.fillStyle = colors[i % colors.length];
                            ctx.fillRect(handX + direction * (22 + i * 3), 
                                       handY + (Math.random() - 0.5) * 15, 3, 3);
                        }
                    }
                    
                } else if (weapon.name === "Boomerang") {
                    // V-shaped boomerang
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(handX + direction * 5, handY - 10 - angleOffset/3);
                    ctx.lineTo(handX + direction * 15, handY - angleOffset/3);
                    ctx.lineTo(handX + direction * 5, handY + 10 - angleOffset/3);
                    ctx.stroke();
                    
                } else if (weapon.name === "Firework Launcher") {
                    // Tube launcher
                    ctx.fillStyle = '#DC143C';
                    ctx.fillRect(handX, handY - 10, direction * 28, 20);
                    // Stars when attacking
                    if (this.isAttacking) {
                        ctx.fillStyle = '#FFD700';
                        for (let i = 0; i < 5; i++) {
                            ctx.beginPath();
                            ctx.arc(handX + direction * (30 + i * 4), 
                                   handY + (Math.random() - 0.5) * 12, 3, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    
                } else if (weapon.name === "Bomb Thrower") {
                    // Launcher
                    ctx.fillStyle = '#2F4F4F';
                    ctx.fillRect(handX, handY - 9, direction * 25, 18);
                    // Bomb
                    if (this.isAttacking) {
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(handX + direction * 30, handY, 6, 0, Math.PI * 2);
                        ctx.fill();
                        // Fuse
                        ctx.strokeStyle = '#FF4500';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(handX + direction * 30, handY - 6);
                        ctx.lineTo(handX + direction * 32, handY - 12);
                        ctx.stroke();
                    }
                    
                } else if (weapon.name === "Bazooka") {
                    // Large tube
                    ctx.fillStyle = '#556B2F';
                    ctx.fillRect(handX - direction * 5, handY - 12, direction * 40, 24);
                    // Barrel end
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(handX + direction * 35, handY, 13, 0, Math.PI * 2);
                    ctx.fill();
                    // Rocket when attacking
                    if (this.isAttacking) {
                        ctx.fillStyle = '#FF4500';
                        ctx.fillRect(handX + direction * 38, handY - 5, direction * 15, 10);
                        // Fire trail
                        ctx.fillStyle = '#FFA500';
                        for (let i = 0; i < 3; i++) {
                            ctx.fillRect(handX + direction * (38 - i * 5), 
                                       handY - 3 + (Math.random() - 0.5) * 8, direction * 5, 6);
                        }
                    }
                    
                } else {
                    // Default weapon (simple stick)
                    ctx.strokeStyle = weapon.type === 'melee' ? '#888' : '#FFD700';
                    ctx.lineWidth = 4;
                    if (this.isAttacking) {
                        ctx.beginPath();
                        ctx.moveTo(handX, handY);
                        ctx.lineTo(handX + direction * 30, handY - angleOffset);
                        ctx.stroke();
                    } else {
                        ctx.beginPath();
                        ctx.moveTo(handX, handY);
                        ctx.lineTo(handX, handY + 20);
                        ctx.stroke();
                    }
                }
            }
            
            checkMeleeHit(other) {
                if (!this.isAttacking) return false;
                
                // Can't hit invisible players
                if (other.isInvisible()) return false;
                
                const weapon = this.getCurrentWeapon();
                if (!weapon || weapon.type !== 'melee') return false;
                
                const distance = Math.abs(this.x - other.x);
                if (distance > 60) return false;
                
                if (this.facingRight && other.x < this.x) return false;
                if (!this.facingRight && other.x > this.x) return false;
                
                const verticalAlign = Math.abs((this.y + this.height/2) - (other.y + other.height/2)) < 40;
                
                return verticalAlign && this.attackTimer === 14;
            }
        }
        
        // Create weapons
        function createWeapons() {
            return [
                // Original weapons
                new Weapon("Sword", 5, "melee", 1),
                new Weapon("Sword", 10, "melee", 2),
                new Weapon("Banana Sword", 7, "melee", 1),
                new Weapon("Bow", 8, "ranged", 1),
                new Weapon("Gun", 12, "ranged", 2),
                new Weapon("Bow", 15, "ranged", 2),
                
                // TIER 1 - Silly/Weak
                new Weapon("Fish", 5, "melee", 1),
                new Weapon("Water Gun", 6, "ranged", 1),
                new Weapon("Snowball Launcher", 7, "ranged", 1),
                
                // TIER 2 - Fun/Medium
                new Weapon("Frying Pan", 10, "melee", 2),
                new Weapon("Confetti Cannon", 11, "ranged", 2),
                new Weapon("Boomerang", 12, "ranged", 2),
                
                // TIER 3 - Cool/Strong
                new Weapon("Giant Lollipop", 15, "melee", 3),
                new Weapon("Firework Launcher", 17, "ranged", 3),
                
                // TIER 4 - Very Strong
                new Weapon("Lightsaber", 22, "melee", 4),
                new Weapon("Chainsaw", 23, "melee", 4),
                new Weapon("Bomb Thrower", 24, "ranged", 4),
                
                // TIER 5 - Epic/Legendary
                new Weapon("Electric Guitar", 32, "melee", 5),
                new Weapon("Bazooka", 35, "ranged", 5)
            ];
        }
        
        // Store functions
        function initializeStore() {
            // Give each player 1 starting Tier 1 weapon
            const weaponsPool = createWeapons();
            const tier1Weapons = weaponsPool.filter(w => w.tier === 1);
            playerData.p1.inventory.push(tier1Weapons[Math.floor(Math.random() * tier1Weapons.length)]);
            playerData.p2.inventory.push(tier1Weapons[Math.floor(Math.random() * tier1Weapons.length)]);
            
            updateStoreUI();
            setupStoreListeners();
        }
        
        function updateStoreUI() {
            // Update coins
            document.getElementById('p1Coins').textContent = playerData.p1.coins;
            document.getElementById('p2Coins').textContent = playerData.p2.coins;
            
            // Update inventories
            updateInventoryDisplay('p1');
            updateInventoryDisplay('p2');
            
            // Update button states
            document.getElementById('p1BuyWeapon').disabled = playerData.p1.coins < 100;
            document.getElementById('p2BuyWeapon').disabled = playerData.p2.coins < 100;
            document.getElementById('p1BuyAbility').disabled = playerData.p1.coins < 200;
            document.getElementById('p2BuyAbility').disabled = playerData.p2.coins < 200;
            
            // Update start battle button
            const canStart = playerData.p1.selectedWeapons.length > 0 && playerData.p2.selectedWeapons.length > 0;
            document.getElementById('startBattleBtn').disabled = !canStart;
        }
        
        function updateInventoryDisplay(player) {
            const data = player === 'p1' ? playerData.p1 : playerData.p2;
            const inventoryDiv = document.getElementById(`${player}Inventory`);
            const selectedSpan = document.getElementById(`${player}Selected`);
            
            inventoryDiv.innerHTML = '';
            
            if (data.inventory.length === 0) {
                inventoryDiv.innerHTML = '<p style="color: #95a5a6;">No weapons yet!</p>';
            } else {
                data.inventory.forEach((weapon, index) => {
                    const card = document.createElement('div');
                    card.className = 'weaponCard';
                    if (data.selectedWeapons.includes(index)) {
                        card.classList.add('selected');
                    }
                    card.innerHTML = `
                        <div class="weaponName">${weapon.name}</div>
                        <div class="weaponTier">Tier ${weapon.tier}</div>
                        <div style="color: #95a5a6; font-size: 14px;">${weapon.type}</div>
                    `;
                    card.onclick = () => toggleWeaponSelection(player, index);
                    inventoryDiv.appendChild(card);
                });
            }
            
            // Update selected display
            if (data.selectedWeapons.length === 0) {
                selectedSpan.textContent = 'None';
            } else {
                const names = data.selectedWeapons.map(i => data.inventory[i].name);
                selectedSpan.textContent = names.join(', ');
            }
        }
        
        function toggleWeaponSelection(player, index) {
            const data = player === 'p1' ? playerData.p1 : playerData.p2;
            const selectedIndex = data.selectedWeapons.indexOf(index);
            
            if (selectedIndex > -1) {
                // Deselect
                data.selectedWeapons.splice(selectedIndex, 1);
            } else {
                // Select (max 3)
                if (data.selectedWeapons.length < 3) {
                    data.selectedWeapons.push(index);
                }
            }
            
            updateStoreUI();
        }
        
        function buyMysteryBox(player) {
            const data = player === 'p1' ? playerData.p1 : playerData.p2;
            
            if (data.coins >= 100) {
                data.coins -= 100;
                
                // Get random weapon
                const weaponsPool = createWeapons();
                const newWeapon = weaponsPool[Math.floor(Math.random() * weaponsPool.length)];
                data.inventory.push(newWeapon);
                
                updateStoreUI();
                alert(`${player === 'p1' ? 'Player 1' : 'Player 2'} got: ${newWeapon.name} (Tier ${newWeapon.tier})!`);
            }
        }
        
        function buyAbility(player) {
            const data = player === 'p1' ? playerData.p1 : playerData.p2;
            
            if (data.coins >= 200) {
                data.coins -= 200;
                const newAbility = getRandomAbility();
                const oldAbility = data.ability;
                data.ability = newAbility;
                updateStoreUI();
                
                if (oldAbility) {
                    alert(`${player === 'p1' ? 'Player 1' : 'Player 2'} replaced ${oldAbility} with ${newAbility}!`);
                } else {
                    alert(`${player === 'p1' ? 'Player 1' : 'Player 2'} got ability: ${newAbility}!`);
                }
            }
        }
        
        function buySkin(player, color) {
            const data = player === 'p1' ? playerData.p1 : playerData.p2;
            
            if (data.coins >= 10) {
                data.coins -= 10;
                data.color = color;
                updateStoreUI();
                alert(`${player === 'p1' ? 'Player 1' : 'Player 2'} bought new skin!`);
            }
        }
        
        function setupStoreListeners() {
            document.getElementById('p1BuyWeapon').onclick = () => buyMysteryBox('p1');
            document.getElementById('p2BuyWeapon').onclick = () => buyMysteryBox('p2');
            document.getElementById('p1BuyAbility').onclick = () => buyAbility('p1');
            document.getElementById('p2BuyAbility').onclick = () => buyAbility('p2');
            
            // Skin buttons
            document.querySelectorAll('.skinBtn').forEach(btn => {
                btn.onclick = () => {
                    const player = btn.dataset.player === '1' ? 'p1' : 'p2';
                    const color = btn.dataset.color;
                    buySkin(player, color);
                };
            });
            
            document.getElementById('startBattleBtn').onclick = startBattle;
        }
        
        // Create weapons
        function createWeapons_old() {
            return [
                new Weapon("Sword", 5, "melee", 1),
                new Weapon("Sword", 10, "melee", 2),
                new Weapon("Banana Sword", 7, "melee", 1),
                new Weapon("Bow", 8, "ranged", 1),
                new Weapon("Gun", 12, "ranged", 2),
                new Weapon("Bow", 15, "ranged", 2)
            ];
        }
        
        // Create platforms based on map type
        function createPlatformsForMap(mapType) {
            const groundY = canvas.height - 50;
            
            if (mapType === 'normal' || mapType === 'comet_field') {
                // Reachable platforms - max vertical gap of 120 pixels
                return [
                    // Lower level
                    new Platform(150, groundY - 100, 180, 20),
                    new Platform(750, groundY - 100, 180, 20),
                    // Mid level (120 pixels up from lower)
                    new Platform(80, groundY - 220, 140, 20),
                    new Platform(450, groundY - 230, 220, 20),
                    new Platform(950, groundY - 220, 140, 20),
                    // High level (120 pixels up from mid)
                    new Platform(500, groundY - 360, 180, 20)
                ];
            } else if (mapType === 'volcano') {
                // Similar layout but slightly different positions
                return [
                    new Platform(100, groundY - 110, 200, 20),
                    new Platform(700, groundY - 110, 200, 20),
                    new Platform(400, groundY - 240, 250, 20),
                    new Platform(900, groundY - 240, 150, 20),
                    new Platform(150, groundY - 370, 180, 20),
                    new Platform(550, groundY - 370, 180, 20)
                ];
            } else if (mapType === 'ice') {
                // Ice map with very high middle platform
                return [
                    new Platform(100, groundY - 100, 180, 20),
                    new Platform(750, groundY - 100, 180, 20),
                    new Platform(50, groundY - 220, 140, 20),
                    new Platform(900, groundY - 220, 140, 20),
                    new Platform(350, groundY - 340, 180, 20),
                    new Platform(650, groundY - 340, 180, 20),
                    // Very high middle platform
                    new Platform(480, groundY - 480, 220, 20, 'lightblue')
                ];
            } else if (mapType === 'alien_invasion') {
                // No platforms for alien invasion - just ground
                return [];
            }
            
            return [];
        }
        
        let platforms = [];
        
        // Create players
        let player1, player2;
        
        function initializeGame() {
            // Reset game state
            gameState.projectiles = [];
            gameState.comets = [];
            gameState.cometSpawnTimer = 0;
            gameState.icicles = [];
            gameState.icicleSpawnTimer = 0;
            gameState.lavaHeight = 0;
            gameState.lavaRiseTimer = 0;
            gameState.spaceships = [];
            gameState.beamedPlayers = { p1: null, p2: null };
            
            // Choose random map
            const maps = ['normal', 'comet_field', 'volcano', 'ice', 'alien_invasion'];
            gameState.currentMap = maps[Math.floor(Math.random() * maps.length)];
            
            // Create platforms for this map
            platforms = createPlatformsForMap(gameState.currentMap);
            
            // Initialize map-specific hazards
            if (gameState.currentMap === 'alien_invasion') {
                // Create 5 spaceships at different positions and heights
                gameState.spaceships = [
                    new Spaceship(200, 150, 200),   // Lifts to 200px above ground
                    new Spaceship(400, 100, 350),   // Lifts to 350px above ground
                    new Spaceship(600, 120, 280),   // Lifts to 280px above ground
                    new Spaceship(800, 140, 240),   // Lifts to 240px above ground
                    new Spaceship(1000, 110, 320)   // Lifts to 320px above ground
                ];
            }
            
            // Create players with selected weapons
            // Both players can use WASD OR Arrow keys, and 1-2-3 for weapons
            player1 = new Player(100, 100, playerData.p1.color, 'Player 1', {
                left: ['a', 'ArrowLeft'], right: ['d', 'ArrowRight'], jump: ['w', 'ArrowUp'], attack: ['s', 'ArrowDown'],
                weapon1: '1', weapon2: '2', weapon3: '3'
            });

            player2 = new Player(1000, 100, playerData.p2.color, 'Player 2', {
                left: ['a', 'ArrowLeft'], right: ['d', 'ArrowRight'], jump: ['w', 'ArrowUp'], attack: ['s', 'ArrowDown'],
                weapon1: '1', weapon2: '2', weapon3: '3'
            });
            
            // Assign selected weapons
            player1.weapons = playerData.p1.selectedWeapons.map(i => playerData.p1.inventory[i]);
            player2.weapons = playerData.p2.selectedWeapons.map(i => playerData.p2.inventory[i]);
            
            // Assign abilities
            player1.ability = playerData.p1.ability;
            player2.ability = playerData.p2.ability;
        }
        
        // Create players (initial - will be recreated)
        let player1_old = new Player(100, 100, '#3498db', 'Player 1', {
            left: 'a', right: 'd', jump: 'w', attack: 's',
            weapon1: '1', weapon2: '2', weapon3: '3'
        });
        
        // Assign weapons
        function getRandomWeapons(pool, count) {
            const shuffled = [...pool].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }
        
        function getRandomAbility() {
            const abilities = ['invisibility', 'shield', 'speed', 'teleport'];
            return abilities[Math.floor(Math.random() * abilities.length)];
        }
        
        function startBattle() {
            if (playerData.p1.selectedWeapons.length === 0 || playerData.p2.selectedWeapons.length === 0) {
                alert('Both players must select at least 1 weapon!');
                return;
            }
            
            // Hide store, show game
            document.getElementById('storeScreen').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            
            gameState.inStore = false;
            gameState.gameOver = false;
            gameState.winner = null;
            
            // Initialize game
            initializeGame();
            gameLoop();
        }
        
        function returnToStore(winner) {
            // Award coins
            if (winner === player1) {
                playerData.p1.coins += 100;
            } else {
                playerData.p2.coins += 100;
            }
            
            // Clear selections
            playerData.p1.selectedWeapons = [];
            playerData.p2.selectedWeapons = [];
            
            // Show store, hide game
            document.getElementById('storeScreen').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            
            gameState.inStore = true;
            
            // Update store
            updateStoreUI();
        }
        
        function getRandomAbility_old() {
            const abilities = ['invisibility', 'shield', 'speed', 'teleport'];
            return abilities[Math.floor(Math.random() * abilities.length)];
        }
        
        // Draw background
        function drawBackground() {
            const mapType = gameState.currentMap;
            
            if (mapType === 'ice') {
                // Ice map - blue/white
                ctx.fillStyle = '#E0F6FF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw mountains in background
                ctx.fillStyle = '#B0C4DE';
                ctx.beginPath();
                ctx.moveTo(0, canvas.height - 150);
                ctx.lineTo(200, canvas.height - 350);
                ctx.lineTo(400, canvas.height - 150);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(300, canvas.height - 150);
                ctx.lineTo(500, canvas.height - 400);
                ctx.lineTo(700, canvas.height - 150);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(600, canvas.height - 150);
                ctx.lineTo(800, canvas.height - 380);
                ctx.lineTo(1000, canvas.height - 150);
                ctx.fill();
                
                // Snow caps
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.moveTo(180, canvas.height - 330);
                ctx.lineTo(200, canvas.height - 350);
                ctx.lineTo(220, canvas.height - 330);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(480, canvas.height - 380);
                ctx.lineTo(500, canvas.height - 400);
                ctx.lineTo(520, canvas.height - 380);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(780, canvas.height - 360);
                ctx.lineTo(800, canvas.height - 380);
                ctx.lineTo(820, canvas.height - 360);
                ctx.fill();
                
            } else if (mapType === 'alien_invasion') {
                // Dark space background
                ctx.fillStyle = '#0a0a20';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Stars
                ctx.fillStyle = 'white';
                for (let i = 0; i < 100; i++) {
                    const x = (i * 73) % canvas.width;
                    const y = (i * 127) % canvas.height;
                    ctx.fillRect(x, y, 2, 2);
                }
                
                // Draw spaceships
                for (let ship of gameState.spaceships) {
                    ship.draw();
                }
                
                // Draw big crater in middle
                const craterCenterX = canvas.width / 2;
                const craterCenterY = canvas.height - 50;
                const craterRadius = 80;
                
                ctx.fillStyle = '#050510';
                ctx.beginPath();
                ctx.arc(craterCenterX, craterCenterY, craterRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // Crater rim
                ctx.strokeStyle = '#1a1a30';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.arc(craterCenterX, craterCenterY, craterRadius, 0, Math.PI * 2);
                ctx.stroke();
                
            } else if (mapType === 'volcano') {
                // Volcanic/orange tinted sky
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#8B4513');
                gradient.addColorStop(1, '#CD5C5C');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw lava at bottom
                if (gameState.lavaHeight > 0) {
                    const lavaGradient = ctx.createLinearGradient(0, canvas.height - gameState.lavaHeight, 0, canvas.height);
                    lavaGradient.addColorStop(0, '#FF4500');
                    lavaGradient.addColorStop(1, '#FF6347');
                    ctx.fillStyle = lavaGradient;
                    ctx.fillRect(0, canvas.height - gameState.lavaHeight, canvas.width, gameState.lavaHeight);
                }
                
            } else {
                // Normal/Comet field - default sky
                // Sky gradient already set in CSS
            }
            
            // Ground (except alien invasion which has no ground visible)
            if (mapType !== 'alien_invasion') {
                if (mapType === 'ice') {
                    ctx.fillStyle = '#F0F8FF';
                } else if (mapType === 'volcano') {
                    ctx.fillStyle = '#8B4513';
                } else {
                    ctx.fillStyle = '#228B22';
                }
                ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            } else {
                // Alien ground (dark)
                ctx.fillStyle = '#1a1a30';
                ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            }
            
            // Trees/decorations for normal maps
            if (mapType === 'normal' || mapType === 'comet_field') {
                drawTree(50, canvas.height - 150);
                drawTree(1100, canvas.height - 150);
                
                // Clouds
                drawCloud(300, 100);
                drawCloud(800, 150);
            }
        }
        
        function drawTree(x, y) {
            // Trunk
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x, y, 20, 100);
            
            // Leaves
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.arc(x + 10, y, 40, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawCloud(x, y) {
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x, y, 30, 0, Math.PI * 2);
            ctx.arc(x + 30, y, 35, 0, Math.PI * 2);
            ctx.arc(x + 60, y, 30, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Update UI
        function updateUI() {
            // Don't update if players don't exist yet
            if (!player1 || !player2) return;
            
            const weapon1 = player1.getCurrentWeapon();
            const weapon2 = player2.getCurrentWeapon();
            
            const ability1Name = player1.ability ? (player1.ability.charAt(0).toUpperCase() + player1.ability.slice(1)) : 'None';
            const ability2Name = player2.ability ? (player2.ability.charAt(0).toUpperCase() + player2.ability.slice(1)) : 'None';
            
            document.getElementById('player1Info').textContent = 
                `P1: ${weapon1 ? weapon1.name + ' (T' + weapon1.tier + ')' : 'No Weapon'} | ${ability1Name}`;
            document.getElementById('player2Info').textContent = 
                `P2: ${weapon2 ? weapon2.name + ' (T' + weapon2.tier + ')' : 'No Weapon'} | ${ability2Name}`;
        }
        
        // Game loop
        function gameLoop() {
            if (!gameState.running || gameState.inStore) return;
            if (!player1 || !player2) return; // Safety check
            
            if (gameState.inMinigame) {
                // Minigame logic
                player1.move([]); // No platforms in minigame
                player2.move([]);
                
                updateMinigame();
                
                // Draw minigame
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawMinigame();
                
                requestAnimationFrame(gameLoop);
                return;
            }
            
            if (!gameState.gameOver) {
                // Spawn comets on comet field map
                if (gameState.currentMap === 'comet_field') {
                    gameState.cometSpawnTimer++;
                    if (gameState.cometSpawnTimer > 60 + Math.random() * 120) { // Every 1-3 seconds
                        gameState.comets.push(new Comet());
                        gameState.cometSpawnTimer = 0;
                    }
                }
                
                // Spawn icicles on ice map
                if (gameState.currentMap === 'ice') {
                    gameState.icicleSpawnTimer++;
                    if (gameState.icicleSpawnTimer > 120 + Math.random() * 60) { // Every 2-3 seconds
                        // Find the high middle platform
                        const highPlatform = platforms[platforms.length - 1];
                        if (highPlatform) {
                            // Spawn 3-5 icicles at once
                            const numIcicles = 3 + Math.floor(Math.random() * 3);
                            for (let i = 0; i < numIcicles; i++) {
                                const icicleX = highPlatform.x + Math.random() * highPlatform.width;
                                gameState.icicles.push(new Icicle(icicleX, highPlatform.y));
                            }
                        }
                        gameState.icicleSpawnTimer = 0;
                    }
                }
                
                // Rising lava on volcano map
                if (gameState.currentMap === 'volcano') {
                    gameState.lavaRiseTimer++;
                    if (gameState.lavaRiseTimer >= 1200) { // Every 20 seconds
                        gameState.lavaHeight = Math.min(gameState.lavaHeight + 100, 400);
                        gameState.lavaRiseTimer = 0;
                    }
                    
                    // Check lava damage (lava is always visible, starts at 50 height)
                    if (gameState.lavaHeight === 0) {
                        gameState.lavaHeight = 50; // Start with some lava
                    }
                    
                    const lavaY = canvas.height - gameState.lavaHeight;
                    if (player1.y + player1.height >= lavaY) {
                        player1.takeDamage(5); // 5 damage per frame in lava
                    }
                    if (player2.y + player2.height >= lavaY) {
                        player2.takeDamage(5);
                    }
                }
                
                // Alien invasion - beam and crater
                if (gameState.currentMap === 'alien_invasion') {
                    // Check if players are in beams
                    for (let ship of gameState.spaceships) {
                        if (!player1.isBeamed && ship.checkBeamHit(player1)) {
                            player1.isBeamed = true;
                            player1.beamTargetY = canvas.height - 50 - ship.beamHeight;
                        }
                        if (!player2.isBeamed && ship.checkBeamHit(player2)) {
                            player2.isBeamed = true;
                            player2.beamTargetY = canvas.height - 50 - ship.beamHeight;
                        }
                    }
                    
                    // Check crater death (big hole in middle)
                    const craterX = canvas.width / 2;
                    const craterRadius = 80;
                    
                    const p1CenterX = player1.x + player1.width/2;
                    const p1Dist = Math.sqrt(Math.pow(p1CenterX - craterX, 2) + Math.pow(player1.y + player1.height - (canvas.height - 50), 2));
                    if (p1Dist < craterRadius && player1.y + player1.height > canvas.height - 100) {
                        player1.health = 0; // Instant death
                    }
                    
                    const p2CenterX = player2.x + player2.width/2;
                    const p2Dist = Math.sqrt(Math.pow(p2CenterX - craterX, 2) + Math.pow(player2.y + player2.height - (canvas.height - 50), 2));
                    if (p2Dist < craterRadius && player2.y + player2.height > canvas.height - 100) {
                        player2.health = 0; // Instant death
                    }
                }
                
                // Update
                player1.move(platforms);
                player2.move(platforms);
                
                player1.updateTimers();
                player2.updateTimers();
                
                // Update comets
                for (let i = gameState.comets.length - 1; i >= 0; i--) {
                    const comet = gameState.comets[i];
                    comet.update();
                    
                    if (!comet.active) {
                        gameState.comets.splice(i, 1);
                        continue;
                    }
                    
                    // Check comet hits
                    if (comet.checkHit(player1)) {
                        player1.takeDamage(comet.damage);
                        gameState.comets.splice(i, 1);
                    } else if (comet.checkHit(player2)) {
                        player2.takeDamage(comet.damage);
                        gameState.comets.splice(i, 1);
                    }
                }
                
                // Update icicles
                for (let i = gameState.icicles.length - 1; i >= 0; i--) {
                    const icicle = gameState.icicles[i];
                    icicle.update();
                    
                    if (!icicle.active) {
                        gameState.icicles.splice(i, 1);
                        continue;
                    }
                    
                    // Check icicle hits
                    if (icicle.checkHit(player1)) {
                        player1.takeDamage(icicle.damage);
                        gameState.icicles.splice(i, 1);
                    } else if (icicle.checkHit(player2)) {
                        player2.takeDamage(icicle.damage);
                        gameState.icicles.splice(i, 1);
                    }
                }
                
                // Update projectiles
                for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
                    const proj = gameState.projectiles[i];
                    proj.update();
                    
                    if (!proj.active) {
                        gameState.projectiles.splice(i, 1);
                        continue;
                    }
                    
                    if (proj.checkHit(player1)) {
                        player1.takeDamage(proj.damage);
                        gameState.projectiles.splice(i, 1);
                    } else if (proj.checkHit(player2)) {
                        player2.takeDamage(proj.damage);
                        gameState.projectiles.splice(i, 1);
                    }
                }
                
                // Check melee hits
                if (player1.checkMeleeHit(player2)) {
                    const weapon = player1.getCurrentWeapon();
                    player2.takeDamage(weapon.damage);
                }
                
                if (player2.checkMeleeHit(player1)) {
                    const weapon = player2.getCurrentWeapon();
                    player1.takeDamage(weapon.damage);
                }
                
                // Check winner
                if (player1.health <= 0 && player2.health <= 0) {
                    // TIE - Start minigame!
                    startMinigame();
                } else if (player1.health <= 0) {
                    gameState.gameOver = true;
                    gameState.winner = 'Player 2 (Red)';
                    showGameOver(player2);
                } else if (player2.health <= 0) {
                    gameState.gameOver = true;
                    gameState.winner = 'Player 1 (Blue)';
                    showGameOver(player1);
                }
            }
            
            // Draw
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            
            for (let platform of platforms) {
                platform.draw();
            }
            
            for (let proj of gameState.projectiles) {
                proj.draw();
            }
            
            for (let comet of gameState.comets) {
                comet.draw();
            }
            
            for (let icicle of gameState.icicles) {
                icicle.draw();
            }
            
            player1.draw();
            player2.draw();
            
            updateUI();
            
            // Easter egg snowman
            if (gameState.easterEggCooldown > 0) {
                gameState.easterEggCooldown--;
            }
            
            if (gameState.snowman) {
                gameState.snowman.update();
                gameState.snowman.draw();
                
                if (!gameState.snowman.active) {
                    gameState.snowman = null;
                    gameState.easterEggActive = false;
                    gameState.easterEggCooldown = 300; // 5 second cooldown
                }
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function startMinigame() {
            gameState.inMinigame = true;
            gameState.minigameObjects = [];
            gameState.minigameTimer = 0;
            gameState.minigameSpawnRate = 120; // Start slow
            
            // Reset players for minigame
            player1.health = 100;
            player2.health = 100;
            player1.x = canvas.width / 4 - player1.width / 2;
            player1.y = canvas.height - 50 - player1.height;
            player1.velY = 0;
            player1.onGround = true;
            player1.isBeamed = false;
            player1.slideVel = 0;
            
            player2.x = (canvas.width * 3) / 4 - player2.width / 2;
            player2.y = canvas.height - 50 - player2.height;
            player2.velY = 0;
            player2.onGround = true;
            player2.isBeamed = false;
            player2.slideVel = 0;
        }
        
        function updateMinigame() {
            gameState.minigameTimer++;
            
            // Ramp up difficulty over time
            if (gameState.minigameTimer < 600) { // First 10 seconds
                gameState.minigameSpawnRate = 120 - (gameState.minigameTimer / 10); // 120 to 60
            } else {
                gameState.minigameSpawnRate = Math.max(20, 60 - ((gameState.minigameTimer - 600) / 20)); // 60 to 20
            }
            
            // Spawn objects
            if (gameState.minigameTimer % Math.floor(gameState.minigameSpawnRate) === 0) {
                // Spawn for left side (Player 1)
                const leftX = Math.random() * (canvas.width / 2 - 40) + 20;
                gameState.minigameObjects.push(new FallingObject(leftX, 'left'));
                
                // Spawn for right side (Player 2)
                const rightX = Math.random() * (canvas.width / 2 - 40) + canvas.width / 2 + 20;
                gameState.minigameObjects.push(new FallingObject(rightX, 'right'));
            }
            
            // Update objects
            for (let i = gameState.minigameObjects.length - 1; i >= 0; i--) {
                const obj = gameState.minigameObjects[i];
                obj.update();
                
                if (!obj.active) {
                    gameState.minigameObjects.splice(i, 1);
                    continue;
                }
                
                // Check hits
                if (obj.checkHit(player1)) {
                    player1.health = 0;
                }
                if (obj.checkHit(player2)) {
                    player2.health = 0;
                }
            }
            
            // Check minigame winner
            if (player1.health <= 0 && player2.health > 0) {
                gameState.inMinigame = false;
                gameState.gameOver = true;
                gameState.winner = 'Player 2 (Red)';
                showGameOver(player2);
            } else if (player2.health <= 0 && player1.health > 0) {
                gameState.inMinigame = false;
                gameState.gameOver = true;
                gameState.winner = 'Player 1 (Blue)';
                showGameOver(player1);
            } else if (player1.health <= 0 && player2.health <= 0) {
                // Double KO in minigame - restart minigame
                startMinigame();
            }
        }
        
        function drawMinigame() {
            // Draw split screen background
            ctx.fillStyle = '#87ceeb';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw dividing line
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            
            // Draw ground
            ctx.fillStyle = '#228B22';
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            
            // Draw falling objects
            for (let obj of gameState.minigameObjects) {
                obj.draw();
            }
            
            // Draw players
            player1.draw();
            player2.draw();
            
            // Draw "TIEBREAKER!" text
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width / 2 - 200, 20, 400, 60);
            
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('DODGE TIEBREAKER!', canvas.width / 2, 65);
            
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText('Last one standing wins!', canvas.width / 2, 95);
            ctx.textAlign = 'left';
        }
        
        function showGameOver(winner) {
            document.getElementById('winnerText').textContent = `${gameState.winner} WINS! +$100`;
            document.getElementById('gameOver').style.display = 'block';
            
            // Return to store after 3 seconds
            setTimeout(() => {
                returnToStore(winner);
            }, 3000);
        }
        
        // Keyboard events
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            // Easter egg detection (G, G, G)
            if (e.key === 'g' || e.key === 'G') {
                gameState.easterEggKeys.push(Date.now());
                // Keep only recent presses (within 2 seconds)
                gameState.easterEggKeys = gameState.easterEggKeys.filter(time => Date.now() - time < 2000);
                
                // Check if we have 3 G presses within 2 seconds
                if (gameState.easterEggKeys.length >= 3 && 
                    !gameState.easterEggActive && 
                    gameState.easterEggCooldown === 0) {
                    gameState.snowman = new Snowman();
                    gameState.easterEggActive = true;
                    gameState.easterEggKeys = [];
                }
            }
            
            // Weapon switching - both players use 1, 2, 3
            if (e.key === '1') {
                if (player1) player1.switchWeapon(0);
                if (player2) player2.switchWeapon(0);
            }
            if (e.key === '2') {
                if (player1) player1.switchWeapon(1);
                if (player2) player2.switchWeapon(1);
            }
            if (e.key === '3') {
                if (player1) player1.switchWeapon(2);
                if (player2) player2.switchWeapon(2);
            }
            
            // Abilities - Space or Enter activates both players' abilities
            if (e.key === ' ' || e.key === 'Enter') {
                if (player1 && player1.activateAbility()) {
                    if (player1.ability === 'teleport') {
                        player1.x = 200 + Math.random() * (canvas.width - 400);
                        player1.y = 200;
                    }
                }
                if (player2 && player2.activateAbility()) {
                    if (player2.ability === 'teleport') {
                        player2.x = 200 + Math.random() * (canvas.width - 400);
                        player2.y = 200;
                    }
                }
                e.preventDefault();
            }

            // Attack - S or ArrowDown attacks for both players
            if (e.key === 's' || e.key === 'ArrowDown') {
                if (player1) {
                    const weapon = player1.attack();
                    if (weapon && weapon.type === 'ranged') {
                        const dir = player1.facingRight ? 1 : -1;
                        const projX = player1.facingRight ? player1.x + player1.width : player1.x;
                        gameState.projectiles.push(
                            new Projectile(projX, player1.y + player1.height/2, dir, weapon.damage, '#FFA500')
                        );
                    }
                }
                if (player2) {
                    const weapon = player2.attack();
                    if (weapon && weapon.type === 'ranged') {
                        const dir = player2.facingRight ? 1 : -1;
                        const projX = player2.facingRight ? player2.x + player2.width : player2.x;
                        gameState.projectiles.push(
                            new Projectile(projX, player2.y + player2.height/2, dir, weapon.damage, '#FFD700')
                        );
                    }
                }
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // Global animation loop for easter egg (runs even in store)
        function globalAnimationLoop() {
            // Update easter egg cooldown
            if (gameState.easterEggCooldown > 0) {
                gameState.easterEggCooldown--;
            }
            
            // Update and draw snowman if active
            if (gameState.snowman) {
                // Only update/draw on canvas if we're in a screen with canvas
                if (document.getElementById('gameCanvas').style.display !== 'none' || 
                    document.getElementById('storeScreen').style.display === 'block') {
                    
                    // Create temporary canvas context for store
                    if (gameState.inStore) {
                        // Draw on a floating div overlay for store
                        let overlay = document.getElementById('snowmanOverlay');
                        if (!overlay) {
                            overlay = document.createElement('canvas');
                            overlay.id = 'snowmanOverlay';
                            overlay.width = 1200;
                            overlay.height = 700;
                            overlay.style.position = 'absolute';
                            overlay.style.top = '50%';
                            overlay.style.left = '50%';
                            overlay.style.transform = 'translate(-50%, -50%)';
                            overlay.style.pointerEvents = 'none';
                            overlay.style.zIndex = '1000';
                            document.getElementById('gameContainer').appendChild(overlay);
                        }
                        
                        const overlayCtx = overlay.getContext('2d');
                        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                        
                        // Save current ctx and use overlay
                        const oldCtx = ctx;
                        window.ctx = overlayCtx;
                        gameState.snowman.update();
                        gameState.snowman.draw();
                        window.ctx = oldCtx;
                    } else {
                        // Already drawn in game loop
                    }
                    
                    if (!gameState.snowman.active) {
                        gameState.snowman = null;
                        gameState.easterEggActive = false;
                        gameState.easterEggCooldown = 300;
                        
                        // Remove overlay if it exists
                        const overlay = document.getElementById('snowmanOverlay');
                        if (overlay) overlay.remove();
                    }
                }
            }
            
            requestAnimationFrame(globalAnimationLoop);
        }
        
        // Initialize store on load
        initializeStore();
        globalAnimationLoop(); // Start global animation loop
    </script>
</body>
</html>
